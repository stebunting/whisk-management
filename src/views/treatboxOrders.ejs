<%-include('partials/header', { title: 'Treatbox Orders', user }); %>
<% let lastWeek='9999-99'; %>

		<%for (let i = orders.length - 1; i >= 0; i -= 1) {
			const timestamp = orders[i]._id.getTimestamp();
			if (lastWeek != orders[i].delivery.date) {
				if (lastWeek !== '9999-99') {
					%>
			</tbody>
		</table><%
				}
				lastWeek = orders[i].delivery.date;
				const data = getWeekData(lastWeek.substring(5));
				const total = totals.find((x) => x._id === lastWeek);
				%>
		<table class="table table-bordered">
			<thead>
				<tr class="table-info" data-toggle="collapse" data-target="#collapse-<%=lastWeek %>">
					<td colspan="5">
						<h2><%=data.delivery.format('dddd Do MMMM YYYY [(Week] w[)]') %></h2>
							<div class="card">
								<div class="card-body row">
								<ul class="user-info-list col-md-4">
									<li>
										<span class="user-info-subtitle">Orders</span>
									</li>
									<li>
										<span class="user-info-detail">COMBO BOXES:</span>
										<%=total.comboBoxes %>
									</li>
									<li>
										<span class="user-info-detail">TREAT BOXES:</span>
										<%=total.treatBoxes %>
									</li>
									<li>
										<span class="user-info-detail">VEGETABLE BOXES:</span>
										<%=total.vegetableBoxes %>
									</li>
								</ul>
								<ul class="user-info-list col-md-4">
									<li>
										<span class="user-info-subtitle">To Make</span>
									</li>
									<li>
										<span class="user-info-detail">TREAT BOXES TO MAKE:</span>
										<%=total.treatBoxesToMake %>
									</li>
									<li>
										<span class="user-info-detail">VEGETABLE BOXES TO ORDER:</span>
										<%=total.vegetableBoxesToOrder %>
									</li>
								</ul>
								<ul class="user-info-list col-md-4">
									<li>
										<span class="user-info-subtitle">Deliveries</span>
									</li>
									<li>
										<span class="user-info-detail">NUMBER OF DELIVERIES:</span>
										<%=total.deliveries %>
									</li>
									<li>
										<span class="user-info-detail">INCOME:</span>
										<%=total.income %> SEK
									</li>
									<li>
										<a href="/treatbox/csv/<%=lastWeek %>">Download CSV</a>
									</li>
								</ul>
							</div>
						</div>
					</td>
				</tr>
			</thead>
			<tbody class="collapse" id="collapse-<%=lastWeek %>">
				<tr>
					<th class="column">ORDER DATE</th>
					<th class="column">ORDER TIME</th>
					<th class="column">NAME</th>
					<th class="column">ADDRESS</th>
					<th class="column info-status">STATUS</th>
				</tr><% }
				let length;
				let collection;
				let trClass = '';
				if (orders[i].delivery.type === 'collection') {
					collection = true;
					length = 1;
					trClass = 'table-warning';
				} else {
					collection = false;
					length = orders[i].recipients.length;
				}
				for (let j = 0; j < length; j += 1) {
					let recipient;
					recipient = collection ? orders[i] : orders[i].recipients[j];
				%>
				<tr class="<%=trClass %>" data-toggle="collapse" data-target="<%=`#ID-${j}-${orders[i]._id}` %>">
					<td><%=timestamp.toLocaleDateString() %></td>
					<td><%=timestamp.toLocaleTimeString() %></td>
					<td><%=recipient.details.name %></td>
					<td>
						<% if (collection) { %>Collection<% } else { %><%=recipient.delivery.address %>&nbsp;
						<a href="<%=recipient.delivery.url %>" target="_blank" rel="external">
							<img class="icon" src="/icons/location.svg" alt="View in Google Maps" />
						</a><% } %>
					</td>
					<td class="info-status"><%
						if (orders[i].payment.status === 'Paid') {
							%><img class="icon statusicon-<%=orders[i]._id %>" src="/icons/paid.svg" alt="Paid!" /><%
						} else if (orders[i].payment.status === 'Invoiced') {
							%><img class="icon statusicon-<%=orders[i]._id %>" src="/icons/invoice.svg" alt="Invoiced" /><%
						} else if (orders[i].payment.status === 'Ordered') {
							%><img class="icon statusicon-<%=orders[i]._id %>" src="/icons/ordered.svg" alt="Ordered" /><%
						} else if (orders[i].payment.status === 'Cancelled') {
							%><img class="icon statusicon-<%=orders[i]._id %>" src="/icons/cancelled.svg" alt="Cancelled" /><%
						} %>
					</td>
				</tr>
				<tr class="collapsingRow <%=trClass %>">
					<td class="hiddenRow" colspan="5">
						<div class="card collapse" id="<%=`ID-${j}-${orders[i]._id}` %>">
							<div class="card-body row">
								<div class="col-md-6">
									<ul class="user-info-list">
										<li>
											<span class="user-info-subtitle">Ordered By</span>
										</li>
										<li>
											<span class="user-info-detail">NAME:</span>
											<%=orders[i].details.name %>
										</li>
										<li>
											<span class="user-info-detail">PHONE NUMBER:</span>
											<%=orders[i].details.telephone %>&nbsp;
											<a href="tel:<%=orders[i].details.telephone %>">
												<img class="icon" src="/icons/call.svg" alt="Call <%=orders[i].details.name %>" />
											</a>
										</li>
										<li>
											<span class="user-info-detail">E-MAIL ADDRESS:</span>
											<a href="mailto:<%=orders[i].details.email %>"><%=orders[i].details.email %></a>
										</li>
									</ul>
									<% if (collection) { %>
								</div>

								<div class="col-md-6"><% } %>
									<ul class="user-info-list">
										<li>
											<span class="user-info-subtitle">Payment</span>
										</li>
										<li>
											<span class="user-info-detail">COST:</span>
											<%=orders[i].cost.total%> SEK
										</li>
										<li>
											<span class="user-info-detail">PAYMENT METHOD:</span>
											<%=orders[i].payment.method%>
										</li>
										<li>
											<span class="user-info-detail">STATUS:</span> <span class="status-<%=orders[i]._id %>">
											<%if (orders[i].payment.status === 'Paid') {
												%>Paid</span><%
											} else if (orders[i].payment.status === 'Invoiced') {
												%>Invoiced</span> <a href="#" class="markaspaid-<%=orders[i]._id %>">(Mark as Paid)</a>
											<%
											} else if (orders[i].payment.status === 'Ordered') {
												%>Ordered</span> <a href="#" class="markasinvoiced-<%=orders[i]._id %>">(Mark as Invoiced)</a>
											<%
											} else if (orders[i].payment.status === 'Cancelled') {
												%>Cancelled</span><% } %>
										</li>
										<% if (orders[i].payment.method === 'Swish') {
												%><li>
											<div class="form-inline">
												<span class="user-info-detail">REFUND:</span>&nbsp;
												<input class="form-control form-control-sm" type="text" id="swishrefundamount-<%=orders[i]._id %>" placeholder="Amount" />&nbsp;
												<button class="btn btn-sm btn-primary" type="submit" id="swishrefund-<%=orders[i]._id %>">Send</button>
											</div>
										</li><%
											} %>
										<li>
											<button class="btn btn-danger" type="button" name="cancel" value="<%=orders[i]._id %>">Cancel Order</button>
										</li>
									</ul>
								</div>

								<div class="col-md-6"><% if (!collection) { %>
									<ul class="user-info-list">
										<li>
											<span class="user-info-subtitle">Recipient</span>
										</li>
										<li>
											<span class="user-info-detail">NAME:</span>
											<%=recipient.details.name %>
										</li>
										<li>
											<span class="user-info-detail">PHONE NUMBER:</span>
											<%=recipient.details.telephone %>
											<a href="tel:<%=recipient.details.telephone %>">
												<img class="icon" src="/icons/call.svg" alt="Call <%=recipient.details.name %>" />
											</a>
											<a id="smslink-<%=orders[i]._id %>-<%=j %>" href="sms:<%=recipient.details.telephone %>?body=<%=encodeURIComponent(querystring.escape(recipient.delivery.sms)) %>">
												<img class="icon" src="/icons/sms.svg" alt="Send Delivery SMS" />
											</a>
										</li>
										<li>
											<span class="user-info-detail">ADDRESS:</span>
											<%=recipient.delivery.address %>
											<a href="<%=recipient.delivery.url %>" target="_blank" rel="external">
												<img class="icon" src="/icons/location.svg" alt="View in Google Maps" />
											</a>
										</li>
										<li>
											<span class="user-info-detail">NOTES:</span>
											<%=recipient.delivery.addressNotes %>
										</li>
										<li>
											<span class="user-info-detail">MESSAGE:</span>
											<%=recipient.delivery.message %>
										</li>
									</ul><% } %>

									<ul class="user-info-list">
										<li>
											<span class="user-info-detail">ORDER:</span>
											<%=getReadableOrder(recipient.items) %>
										</li>
										<li>
											<a href="#smsedit-<%=`${orders[i]._id}-${j}`%>" data-toggle="modal">Edit Text Message</a>
											<div class="modal" id="smsedit-<%=`${orders[i]._id}-${j}`%>" tabindex="-1" role="dialog">
											  <div class="modal-dialog">
											    <div class="modal-content">
											      <div class="modal-header">
											        <h5 class="modal-title">Edit Delivery SMS</h5>
											        <button type="button" class="close modal-close" data-dismiss="modal" aria-label="Close">
											          <span aria-hidden="true">&times;</span>
											        </button>
											      </div>
											      <div class="modal-body">
											        <textarea class="form-control sms-textarea" rows="8" name="sms-text" id="smstext-<%=orders[i]._id %>-<%=j %>" placeholder="SMS Body"><%=recipient.delivery.sms %></textarea>
											      </div>
											      <div class="modal-footer">
											        <button type="button" class="btn btn-secondary modal-close" data-dismiss="modal">Close</button>
											        <button type="button" class="btn btn-primary" name="update-sms" value="<%=orders[i]._id %>-<%=j %>">Save changes</button>
											      </div>
											    </div>
											  </div>
											</div>
										</li>
									</ul>
								</div>
							</div>
						</div>
					</td>
				</tr><% }} %>
			</tbody>
		</table>
<%- include('partials/footer') %>